# Documentation d’Exploitation – Mini Extranet

## 1. Installation du Serveur Wazuh
```bash
curl -sO https://packages.wazuh.com/4.12/wazuh-install.sh
bash wazuh-install.sh -a
```
Avoir ad minima 50g de stockage et 8g de ram

## 2. Déploiement des Agents Wazuh

### Sur Debian/Ubuntu
```bash
wget https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.12.0-1_amd64.deb && sudo WAZUH_MANAGER='192.168.1.200' dpkg -i ./wazuh-agent_4.12.0-1_amd64.deb
```
Puis
```bash
sudo systemctl daemon-reload
sudo systemctl enable wazuh-agent
sudo systemctl start wazuh-agent
```


### Sur pfSense (via Syslog)
- Aller dans **Status > System Logs > Settings**
  - Activer Syslog vers `192.168.1.200`
  - Protocole : UDP ou TCP 514

## 3. Configuration d'OpenVPN sur pfSense
- **VPN > OpenVPN > Wizards**
  - Créer CA, certificat serveur
  - UDP 1194, tunnel 192.168.200.0/24
- Ajouter règle firewall : autoriser UDP 1194 sur WAN
- Export clients via **OpenVPN Client Export**

## 4. Portail Captif sur pfSense
- **Services > Captive Portal**
  - Zone : LAN
  - Authentification : Local User Manager ou RADIUS
  - Page personnalisée : `/usr/local/captiveportal/index.html`
- Whitelist : Cowmail, Wazuh (par IP/MAC)

## 5. Proxy Squid sur pfSense
- **Services > Squid Proxy Server**
  - Mode : Transparent
  - Port : 3128
  - ACL : à configurer pour filtrage par IP/Groupe/Regex

## 6. Webmail Cowmail

### Installation
```bash
sudo apt update && sudo apt install apache2 php postfix dovecot-imapd dovecot-pop3d -y
sudo cp cowmail /var/www/html/
```
- Configuration : `/var/www/html/cowmail/config.php`
- Accès via : `http://webmail.projet.local`
- Limité à LAN/VPN, pas de HTTPS (absence de domaine)

## 7. Sauvegarde / Restauration

### Sauvegarde et restauration automatisées

Le système met en place une stratégie de sauvegarde et de restaurations :

- `/usr/local/bin/backup_mailcow.sh` : effectue la sauvegarde
- `/usr/local/bin/restore_mailcow.sh` : gère la restauration

### Sauvegarde quotidienne

Le script de sauvegarde est exécuté automatiquement chaque jour à **03h00** via une tâche `cron` configurée ainsi :

```cron
0 3 * * * /usr/local/bin/backup_mailcow.sh
```

Tous les événements sont journalisés dans :

```
/var/log/mailcow_backup.log
```

#### Restauration manuelle (avec confirmation)

La restauration s’effectue manuellement via le script dédié :

```bash
/usr/local/bin/restore_mailcow.sh
```

Tous les événements sont journalisés dans :

```
/var/log/mailcow_restore.log
```

